1ã€ç¡¬ä»¶è¿æ¥(æ ¹æ®æ£€æµ‹ï¼Œmellanox cx6-lxç½‘å¡ä¸èƒ½è·‘IBï¼Œåªèƒ½è·‘RoCE)
    æ¯ä¸ªæœåŠ¡å™¨æœ‰2ä¸ª25Gbpsçš„å…‰çº¤æ¨¡å—ï¼Œç”¨2æ ¹å…‰çº¤ç›´è¿ï¼ˆä¸éœ€è¦äº¤æ¢æœºï¼Œä½†éœ€è¦æ³¨æ„txå’Œrxçš„å¯¹æ¥ï¼‰

2ã€å®‰è£…mellanoxç½‘å¡é©±åŠ¨
    ä¸‹è½½å’Œå®‰è£…ï¼ˆæ— æ³•ç›´æ¥wgetï¼Œè¦tgzçš„é“¾æ¥ç‚¹è¿›å»ä¸‹è½½åä¸Šä¼ è‡³æœåŠ¡å™¨ï¼‰
        https://network.nvidia.com/products/infiniband-drivers/linux/mlnx_ofed/
        tar -xvf MLNX_OFED_LINUX-24.10-2.1.8.0-openeuler22.03sp3-x86_64.tar
        sudo yum install pciutils-devel tk fuse-devel
        cd MLNX_OFED_LINUX-24.10-2.1.8.0-openeuler22.03sp3-x86_64/
        sudo ./mlnxofedinstall
        sudo dracut -f
        sudo /etc/init.d/openibd restart(ä¼¼ä¹ä¸éœ€è¦)
        sudo reboot
    æµ‹è¯•
        ibstat
        ibv_devinfo
        rdma link show
    è®¾ç½®IPï¼ˆRoCEæ—¶2ä¸ªæœåŠ¡å™¨çš„è®¾ç½®mtu 9000ï¼ˆæœ‰è¯´>4200å³å¯ï¼‰å¾ˆé‡è¦ï¼ŒIBæ—¶è®¾ç½®mtu 4096ï¼‰
        æœåŠ¡å™¨Aï¼š
            sudo nmcli con add type ethernet ifname ens19f0np0 con-name ens19f0np0 ip4 192.168.88.1/24
            sudo nmcli con mod ens19f0np0 802-3-ethernet.mtu 9000
            sudo nmcli con up  ens19f0np0
                å¦‚æœsudo nmcli con addæŠ¥é”™æœ‰å…¶ä»–è”æ¥ï¼š
                    æŸ¥çœ‹æ‰€æœ‰å…³è”çš„uuidï¼šnmcli -f NAME,UUID,TYPE,DEVICE,AUTOCONNECT connection show | grep ens19f0np0
                    åˆ é™¤æ‰€æœ‰å…³è”ï¼šsudo nmcli connection delete uuid xxxxï¼ˆå¦‚552b586d-02c7-410e-be0f-464a442d6f63ï¼‰

            sudo nmcli con add type ethernet ifname ens19f1np1 con-name ens19f1np1 ip4 192.168.88.11/24
            sudo nmcli con mod ens19f1np1 802-3-ethernet.mtu 9000
            sudo nmcli con up  ens19f1np1
        æœåŠ¡å™¨Bï¼š
            sudo nmcli con add type ethernet ifname ens19f0np0 con-name ens19f0np0 ip4 192.168.88.2/24
            sudo nmcli con mod ens19f0np0 802-3-ethernet.mtu 9000
            sudo nmcli con up  ens19f0np0

            sudo nmcli con add type ethernet ifname ens19f1np1 con-name ens19f1np1 ip4 192.168.88.22/24
            sudo nmcli con mod ens19f1np1 802-3-ethernet.mtu 9000
            sudo nmcli con up  ens19f1np1
        æ­¤æ—¶å¯ä»¥ping 192.168.88.2
    ï¼ˆRoCEå¡ä¸éœ€è¦ï¼‰è®¾ç½®IBæ¨¡å¼ï¼ˆä¼¼ä¹ä¸è¡Œï¼Œä¹Ÿå¯èƒ½ä¸éœ€è¦ï¼‰
        å¯åŠ¨mellanoxç®¡ç†ç¨‹åº
            sudo modprobe mst_pci
            sudo mst start
        æŸ¥çœ‹è®¾å¤‡
            sudo mst status
            sudo mlxconfig -d /dev/mst/mt4127_pciconf0 q | grep LINK_TYPEï¼ˆè¿™é‡Œæ€»æ˜¯è¿”å›ç©ºï¼‰

3ã€æ­¤æ—¶å³å¯2ä¸ªæœåŠ¡å™¨ä¹‹é—´å¿«é€Ÿcopyï¼ˆå¦‚ä»192.168.88.1å¤åˆ¶sync_testæ–‡ä»¶å¤¹åˆ°192.168.88.2ï¼‰
    rsync -avz --checksum ./sync_test tutu@192.168.88.2:/home/tutu/sync_test

4ã€ncclé€šä¿¡æ£€æŸ¥ï¼ˆä¸»è¦æµ‹è¯•ä¸ç”¨IBå’ŒRoCEã€åªç”¨socketè¡Œä¸è¡Œï¼‰
    1ã€ï¼ˆè¿™æ¡æ²¡ç”¨ï¼‰æ²¡æœ‰äº¤æ¢æœºæ—¶ï¼ŒIBæ¨¡å¼éœ€è¦è£…opensmã€Base lidä¸èƒ½ä¸º0ï¼ˆåº”ä¸º0x2ä¹‹ç±»ï¼‰
    2ã€ï¼ˆè¿™æ¡æ²¡ç”¨ï¼‰æ ¹æ®æ£€æµ‹ï¼Œcx6-lxç½‘å¡ä¸èƒ½è·‘IBï¼Œåªèƒ½è·‘RoCEï¼ˆmlxconfig å›ç­” â€œThe Device doesn't support LINK_TYPE_P1â€ çš„æ ¹æœ¬åŸå› ï¼Œæ˜¯ è¿™ç±» EN å¡ç¡¬ä»¶åªæ”¯æŒ Ethernet /RoCEï¼Œå‹æ ¹æ²¡æœ‰ InfiniBand æ¨¡å¼ï¼Œæ‰€ä»¥ä¹Ÿå°±æ²¡æœ‰ LINK_TYPE_P* å‚æ•°å¯æ”¹ã€‚å®˜æ–¹è®ºå›ç»™è¿‡åŒæ ·ç»“è®ºï¼šåªæœ‰ VPI å‹å· æ‰èƒ½åˆ‡æ¢ç«¯å£ç±»å‹ï¼›DX/Lx ç­‰ ETHâ€‘only å¡ä¸èƒ½åˆ‡æ¢ã€‚äº§å“æ‰‹å†Œä¹Ÿæ˜ç¡®æŠŠ ConnectXâ€‘6 Lx å®šä¹‰ä¸º Ethernet adapter cardsï¼‰
        ï¼ˆä½†æ˜¯å‰é¢çš„IBé©±åŠ¨éœ€è¦ï¼Œæœ€åè¦ç¡®ä¿2ä¸ªæœåŠ¡å™¨çš„NCCL_IB_HCAæ­£ç¡®ï¼Œå¯èƒ½æ˜¯rocep39s0f0,rocep39s0f1ï¼Œä¹Ÿå¯èƒ½æ˜¯mlx5_0,mlx5_1ï¼Œè€ŒNCCL_SOCKET_IFNAMEåªéœ€è¦å¡«ä¸€ä¸ªç½‘å¡è®¾å¤‡å·å¦‚ens19f0np0å³å¯ï¼ˆä»…ç”¨äºæ¡æ‰‹è€ŒéRDMAé€šä¿¡ï¼‰ï¼‰
    3ã€å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•ä¸ç”¨IBæ¨¡å¼ä¹Ÿä¸ç”¨RoCEæ¨¡å¼ï¼ˆå½“æ™®é€š25Gbpsç½‘å¡ç”¨ï¼Œåªæ˜¯å»¶æ—¶æ˜¯å‡ åmsè€Œä¸æ˜¯å‡ msï¼‰
        export NCCL_IB_DISABLE=1
        export NCCL_SOCKET_IFNAME=ens19f0np0
        sudo systemctl stop firewalldï¼ˆè¿™é‡Œéå¸¸å…³é”®ï¼ï¼ï¼ï¼šæ³¨æ„é‡å¯åé˜²ç«å¢™å°±ä¼šæ‰“å¼€ï¼Œå¦å¤–è¿™é‡Œä¸»è¦æ˜¯æ”¾è¡ŒIBæˆ–RoCEçš„ç«¯å£å¦‚49152â€“65535ï¼‰
        æœåŠ¡å™¨Aï¼štorchrun --nproc-per-node=4 --nnodes=2 --node-rank=0 --master-addr=192.168.88.1 --master-port=28002 test.py
        æœåŠ¡å™¨Bï¼štorchrun --nproc-per-node=4 --nnodes=2 --node-rank=1 --master-addr=192.168.88.1 --master-port=28002 test.py
-------------------------------test.py-------------------------------
import os
import torch
import torch.distributed as dist

def setup():
    dist.init_process_group(backend="nccl", init_method="env://")
    rank = dist.get_rank()
    local_rank = int(os.environ["LOCAL_RANK"])
    torch.cuda.set_device(local_rank)

    t = torch.tensor([rank], device='cuda')
    dist.all_reduce(t)
    print(f"[Rank {rank}] All-Reduced Value: {t.item()}")

if __name__ == "__main__":
    setup()
------------------------------/test.py-------------------------------
        test.pyå¯ä»¥é€šè¿‡ï¼ˆæ­¤æ—¶å³å¯ç”¨ï¼Œåç»­RoCEæˆ–è€…IBæ¨¡å¼å¯ä»¥å»¶æ—¶å†ä½ä¸€ä¸ªæ•°é‡çº§ï¼‰

    4ã€ä»¥ä¸‹å‘½ä»¤ç”¨äºæ£€æŸ¥2ä¸ªæœåŠ¡å™¨è½¯ä»¶æ˜¯å¦ç‰ˆæœ¬ç›¸åŒï¼š
        ofed_info -s         # MLNX_OFED
        rpm -q rdma-core     # å‘è¡Œç‰ˆé©±åŠ¨
    5ã€éªŒè¯RDMAè¿é€šæ€§
        sudo yum install -y perftest rdma-core
        æœåŠ¡å™¨Aï¼šib_write_bw -d mlx5_0 -F -x 3 192.168.88.2
        æœåŠ¡å™¨Bï¼šib_write_bw -d mlx5_0 -F -x 3
        æœåŠ¡å™¨Aå’ŒBçš„ç»“æœåº”ä¸ºç±»ä¼¼è¿™æ ·ï¼š
---------------------------------------------------------------------------------------
                    RDMA_Write BW Test
 Dual-port       : OFF          Device         : mlx5_0
 Number of qps   : 1            Transport type : IB
 Connection type : RC           Using SRQ      : OFF
 PCIe relax order: ON           Lock-free      : OFF
 ibv_wr* API     : ON           Using DDP      : OFF
 TX depth        : 128
 CQ Moderation   : 1
 Mtu             : 4096[B]
 Link type       : Ethernet
 GID index       : 3
 Max inline data : 0[B]
 rdma_cm QPs     : OFF
 Data ex. method : Ethernet
---------------------------------------------------------------------------------------
 local address: LID 0000 QPN 0x00a6 PSN 0x48ddea RKey 0x1ffebc VAddr 0x007f420e49d000
 GID: 00:00:00:00:00:00:00:00:00:00:255:255:192:168:88:01
 remote address: LID 0000 QPN 0x00b9 PSN 0x624485 RKey 0x01dbbc VAddr 0x007f155f635000
 GID: 00:00:00:00:00:00:00:00:00:00:255:255:192:168:88:02
---------------------------------------------------------------------------------------
 #bytes     #iterations    BW peak[MiB/sec]    BW average[MiB/sec]   MsgRate[Mpps]
 65536      5000             2920.76            2920.71              0.046731
---------------------------------------------------------------------------------------

6ã€RoCEçš„è®¾ç½®å’Œæµ‹è¯•ï¼ˆä¸»è¦æ˜¯è§£å†³NCCLçš„é”é¡µå†…å­˜ (memlock)é—®é¢˜ï¼‰
    å…³äºæŠ¥é”™ï¼šibv_reg_mr_iova2 failed with error Cannot allocate memory
        åŸå› ï¼š
            ä¸ºä»€ä¹ˆ NCCL éœ€è¦ â€œé”é¡µå†…å­˜ (memlock)â€ï¼Ÿ
                RDMA ä¼ è¾“å‰å¿…é¡»æŠŠæ˜¾å­˜/å†…å­˜æ³¨å†Œç»™ç½‘å¡ï¼ˆibv_reg_mrï¼‰ï¼Œæ³¨å†Œæ—¶ä¼šæŠŠè¿™å—å†…å­˜â€œé”â€åœ¨ç‰©ç†å†…å­˜é‡Œï¼Œä¸èƒ½è¢«æ¢å‡ºã€‚
                å¦‚æœ memlock é™åˆ¶å¤ªå°ï¼Œé©±åŠ¨ç”³è¯·æ—¶å°±ä¼šå¤±è´¥ï¼Œäºæ˜¯ä½ çœ‹åˆ°ï¼š
        (ä¸éœ€è¦äº†ï¼‰ä¸´æ—¶è§£å†³ï¼š
            2ä¸ªæœåŠ¡å™¨éƒ½è¿è¡Œsudo prlimit --pid $$ --memlock=unlimited:unlimited
            sudo prlimit --pid $$ --memlock=unlimited:unlimited åˆ°åº•åšäº†ä»€ä¹ˆï¼Ÿ
                prlimit æ˜¯ Linux è‡ªå¸¦çš„ä¸€ä¸ªå·¥å…·ï¼Œç”¨æ¥åœ¨ è¿›ç¨‹è¿è¡ŒæœŸé—´ ä¿®æ”¹å®ƒçš„èµ„æºé™åˆ¶ï¼ˆç­‰ä»·äº C é‡Œçš„ setrlimit()ï¼‰ã€‚
                --pid $$ æŒ‡å®šè¦ä¿®æ”¹çš„è¿›ç¨‹å°±æ˜¯ä½ å½“å‰çš„ Shellï¼ˆ$$ æ˜¯å½“å‰ Shell çš„ PIDï¼‰ã€‚
                --memlock=è½¯é™åˆ¶:ç¡¬é™åˆ¶ æŠŠ RLIMIT_MEMLOCK çš„è½¯ã€ç¡¬ä¸¤çº§é™åˆ¶éƒ½è®¾æˆ unlimitedã€‚
                åŠ äº† sudo æ‰èƒ½æŠŠã€Œç¡¬é™åˆ¶ã€ä¹Ÿè°ƒé«˜â€”â€”æ™®é€šç”¨æˆ·åªèƒ½é™ä½ç¡¬é™åˆ¶ï¼Œä¸èƒ½å‡é«˜ã€‚
                ç»“æœå°±æ˜¯ï¼š
                    å½“å‰ Shell ä»¥åŠå®ƒå¯åŠ¨çš„æ‰€æœ‰å­è¿›ç¨‹ï¼ˆåŒ…æ‹¬ä½ éšåè¿è¡Œçš„ torchrunï¼‰éƒ½æ‹¥æœ‰â€œæ— é™åˆ¶çš„é”é¡µå†…å­˜â€ï¼›
                    ä¸€æ—¦é€€å‡ºè¿™ä¸ª Shellï¼Œè®¾ç½®å°±æ¶ˆå¤±ï¼›æ‰“å¼€æ–°ç»ˆç«¯è¿˜æ˜¯é»˜è®¤çš„ 64 MiBã€‚
        æœ€ç»ˆè§£å†³ï¼š
            1ã€æ‰§è¡Œä¸‹è¿°å‘½ä»¤
sudo tee /etc/security/limits.d/99-nccl.conf <<'EOF'
* soft memlock unlimited
* hard memlock unlimited
EOF
                æ­¤æ—¶ç”¨termiusæ–°ç™»é™†sshï¼Œulimit -léƒ½æ˜¯è¿”å›unlimitedäº†
            2ã€è§£å†³jupyterä»ç„¶è¿”å›65536çš„é—®é¢˜ï¼ˆå› ä¸ºjupyterå¯åŠ¨æ—¶ç»§æ‰¿è‡ªsystemdè€Œä¸æ˜¯PAMï¼Œè€ŒTermiusâ†’sshdâ†’pam_limits.soï¼‰
sudo mkdir -p /etc/systemd/system.conf.d
sudo tee /etc/systemd/system.conf.d/90-memlock.conf <<'EOF'
[Manager]
DefaultLimitMEMLOCK=infinity
EOF
                é‡å¯åï¼Œjupyterå°±èƒ½è¿”å›unlimit
            3ã€æœ€ç»ˆstart_test.shä¸º
# export NCCL_IB_DISABLE=1
# HCAæ˜¯è®¾ç½®RDMAé€šé“ï¼Œæ‰€ä»¥è¦è®¾ç½®mlx5_0å’Œmlx5_1
export NCCL_IB_HCA=mlx5_0,mlx_1
# socket_ifnameåªæ˜¯è®¾ç½®æ¡æ‰‹è®¾å¤‡ï¼Œæ‰€ä»¥åªéœ€è¦ens19f0np0å³å¯
export NCCL_SOCKET_IFNAME=ens19f0np0
# GID_INDEXè®¾ç½®ä¸º3æ˜¯å› ä¸ºæ—§ç‰ˆæœ¬ NCCLï¼ˆ<2.21ï¼‰ä¸ä¼šè‡ªå·±å»â€œçŒœâ€å“ªä¸ª GID èƒ½é€šï¼Œä¸ºäº†è§£å†³ç³»ç»Ÿè¯¯ç”¨INDEX 0çš„é—®é¢˜ï¼Œæ‰§è¡Œshow_gidså¯ä»¥çœ‹åˆ°ä¸‹é¢å†…å®¹(index 0å’Œ1ä¸ºipv6,4)ï¼š
# ã€å› æ­¤NCCL_IB_GID_INDEXè¦è®¾ç½®ä¸ºshow_gidsç»“æœä¸­IPv4æœ‰çš„IPçš„V2é‚£ä¸ªINDEX.ã€ä½†æ˜¯å®æµ‹5å°±æ˜¯ä¼šæœ‰é—®é¢˜ï¼Œ3æ²¡é—®é¢˜ï¼Œä¹Ÿè®¸show_gidsæœ‰åˆ·æ–°é—®é¢˜ã€‘ã€‘
# DEV     PORT    INDEX   GID                                     IPv4            VER     DEV
# ---     ----    -----   ---                                     ------------    ---     ---
# mlx5_0  1       0       fe80:0000:0000:0000:5aa2:e1ff:feb0:3772                 v1      ens19f0np0
# mlx5_0  1       1       fe80:0000:0000:0000:5aa2:e1ff:feb0:3772                 v2      ens19f0np0
# mlx5_0  1       2       fe80:0000:0000:0000:a789:516a:e270:5b33                 v1      ens19f0np0
# mlx5_0  1       3       fe80:0000:0000:0000:a789:516a:e270:5b33                 v2      ens19f0np0
# mlx5_0  1       4       0000:0000:0000:0000:0000:ffff:c0a8:5801 192.168.88.1    v1      ens19f0np0
# mlx5_0  1       5       0000:0000:0000:0000:0000:ffff:c0a8:5801 192.168.88.1    v2      ens19f0np0
# n_gids_found=6
export NCCL_IB_GID_INDEX=3
sudo systemctl stop firewalld
source /home/tutu/miniconda3/etc/profile.d/conda.sh
conda activate sgl45
torchrun --nproc-per-node=4 --nnodes=2 --node-rank=1 --master-addr=192.168.88.1 --master-port=28002 test.py
            æ­¤æ—¶è¿è¡Œstart_test.shï¼Œtest.pyå°±å¯æ­£å¸¸è¿”å›all_reduceç»“æœäº†

7ã€å¤šèŠ‚ç‚¹llama-factoryè®­ç»ƒ
    NCCL_IB_DISABLE=0
    NCCL_P2P_DISABLE=0
    NCCL_SHM_DISABLE=0

    NCCL_IB_GID_INDEX=3
    NCCL_IB_HCA=mlx5_0,mlx5_1
    NCCL_IB_TC=106
    NCCL_SOCKET_IFNAME=ens19f0np0

    æœåŠ¡å™¨Aï¼š
        FORCE_TORCHRUN=1 NNODES=2 NODE_RANK=0 MASTER_ADDR=192.168.88.1 MASTER_PORT=28011 \
            llamafactory-cli train examples/train_lora/llama3_lora_sft.yaml
    æœåŠ¡å™¨Bï¼š
        FORCE_TORCHRUN=1 NNODES=2 NODE_RANK=1 MASTER_ADDR=192.168.88.1 MASTER_PORT=28011 \
            llamafactory-cli train examples/train_lora/llama3_lora_sft.yaml

(æ²¡ç”¨ï¼Œopenmpiç”¨ibï¼Œæˆ‘ä»¬æ˜¯RoCEå¡)7ã€NCCL-testæµ‹è¯•(2ä¸ªæœåŠ¡å™¨ä¸Šéƒ½è¦è£…)
    å®‰è£…ncclï¼š
        https://developer.nvidia.com/nccl/nccl-downloadï¼Œæˆªå›¾ç»™gpt4çœ‹ï¼Œé—®open-eulerå…·ä½“ç‰ˆæœ¬ï¼ˆcat /etc/os-releaseï¼‰ç”¨å“ªä¸ª
        sudo dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
        sudo dnf clean all
        sudo dnf makecache

        # å®‰è£… NCCL 2.26.2 + CUDA 12.8 å¯¹åº”ç‰ˆæœ¬
        sudo dnf install \
            libnccl-2.26.2-1+cuda12.8 \
            libnccl-devel-2.26.2-1+cuda12.8 \
            libnccl-static-2.26.2-1+cuda12.8
    å®‰è£…MPI
        sudo dnf install -y openmpi openmpi-devel
        mpicc --version
        æ‰¾åˆ°mpi.h: find /usr -name mpi.h 2>/dev/null
        vi ~/.bashrc
export CPATH=/usr/include/openmpi-x86_64:$CPATH
export PATH=/usr/lib64/openmpi/bin:$PATH
export LD_LIBRARY_PATH=/usr/lib64/openmpi/lib:$LD_LIBRARY_PATH
export LIBRARY_PATH=/usr/lib64/openmpi/lib:$LIBRARY_PATH
        source ~/.bashrc

    å®‰è£…ç¼–è¯‘nccl-test
        git clone https://github.com/NVIDIA/nccl-tests.git
        cd nccl-tests
        make MPI=1
    æœåŠ¡å™¨Aè®¾ç½®SSH
        ssh-keygenï¼ˆå…¨éƒ¨å›è½¦ï¼‰
        ssh-copy-id tutu@192.168.88.2
        æµ‹è¯•ï¼šssh 192.168.88.2 hostname
    æµ‹è¯•nccl-testï¼ˆæœåŠ¡å™¨Aä¸Šè¿è¡Œå³å¯ï¼‰
        vi nccl-test.sh
#!/bin/bash

# ===== ç”¨æˆ·é…ç½® =====
HOST1=192.168.88.1
HOST2=192.168.88.2
GPUS_PER_NODE=8

# RoCE ç›¸å…³è®¾ç½®
GID_INDEX=3
HCA_LIST="mlx5_0,mlx5_1"   # ğŸ‘‰ åŒæ—¶ä½¿ç”¨ä¸¤ä¸ª HCAï¼Œå¦‚æœåªç”¨ä¸€ä¸ªå°±å†™ mlx5_1

# ç½‘ç»œæ¥å£åï¼Œç”¨äº NCCL_SOCKET_IFNAMEï¼ˆifconfig æˆ– ip a çœ‹ä½  RoCE å¯¹åº”çš„æ˜¯å“ªä¸ªï¼‰
IFNAME=ens19f0np0

# ===== NCCL + RDMA ç¯å¢ƒå˜é‡ =====
export NCCL_DEBUG=INFO
export NCCL_IB_DISABLE=0
export NCCL_IB_GID_INDEX=$GID_INDEX
export NCCL_IB_HCA=$HCA_LIST
export NCCL_NET_GDR_LEVEL=5
export NCCL_SOCKET_IFNAME=$IFNAME
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/usr/lib64:/usr/lib64/openmpi/lib

# ===== è¿è¡Œ NCCL æµ‹è¯• =====
mpirun -np $((GPUS_PER_NODE * 2)) \
  -H ${HOST1}:${GPUS_PER_NODE},${HOST2}:${GPUS_PER_NODE} \
  -x NCCL_DEBUG \
  -x NCCL_IB_DISABLE \
  -x NCCL_IB_GID_INDEX \
  -x NCCL_IB_HCA \
  -x NCCL_NET_GDR_LEVEL \
  -x NCCL_SOCKET_IFNAME \
  -x LD_LIBRARY_PATH \
  ./build/all_reduce_perf -b 8 -e 512M -f 2 -g ${GPUS_PER_NODE}




